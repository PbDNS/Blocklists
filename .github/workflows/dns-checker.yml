name: V√©rification DNS & HTTP des domaines

on:
  workflow_dispatch:
    inputs:
      prefixes:
        description: "Pr√©fixes des domaines √† tester (ex: a, abc, mn)"
        required: true
        default: "a"

  schedule:
    - cron: '0 1 * * *'
    - cron: '0 2 * * *'
    - cron: '0 3 * * *'
    - cron: '0 4 * * *'
    - cron: '0 5 * * *'
    - cron: '0 6 * * *'
    

permissions:
  contents: write  # üîê Autorise les pushs vers le d√©p√¥t

jobs:
  run-check:
    runs-on: ubuntu-latest

    steps:
      - name: üì• Cloner le d√©p√¥t
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: üêç Installer Python et les d√©pendances
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: üì¶ Installer les modules requis
        run: |
          python -m pip install --upgrade pip
          pip install dnspython httpx

      - name: üßÆ D√©terminer les pr√©fixes
        id: set-prefixes
        run: |
          if [[ "${{ github.event_name }}" == "schedule" ]]; then
            hour=$(date -u +"%H")
            case "$hour" in
              "01") echo "value=0123456789" >> $GITHUB_OUTPUT ;;
              "02") echo "value=a" >> $GITHUB_OUTPUT ;;
              "03") echo "value=b" >> $GITHUB_OUTPUT ;;
              "04") echo "value=c" >> $GITHUB_OUTPUT ;;
              "05") echo "value=b" >> $GITHUB_OUTPUT ;;
              "06") echo "value=e" >> $GITHUB_OUTPUT ;;             
            esac
          else
            echo "value=${{ github.event.inputs.prefixes }}" >> $GITHUB_OUTPUT
          fi

      - name: üöÄ Lancer le script de v√©rification
        run: |
          PREFIXES="${{ steps.set-prefixes.outputs.value }}"
          echo "Pr√©fixes utilis√©s : $PREFIXES"
          if [ -n "$PREFIXES" ]; then
            python dns_checker.py "$PREFIXES"
          else
            echo "‚è≠Ô∏è Aucun pr√©fixe √† ex√©cuter pour cette heure."
          fi

      - name: üìå Commit et push de dead.txt
        if: success()
        run: |
          if [ -f dead.txt ]; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add dead.txt
            if git diff --cached --quiet; then
              echo "‚úÖ Aucun changement dans dead.txt √† commiter."
            else
              git commit -m "üîÑ Mise √† jour de dead.txt (pr√©fixes: ${{ steps.set-prefixes.outputs.value }})"
              git push
              echo "‚úÖ dead.txt mis √† jour et pouss√©."
            fi
          else
            echo "‚ùå Fichier dead.txt non trouv√©. Rien √† commiter."
          fi

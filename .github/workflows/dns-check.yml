name: DNS Dead Check

on:
  workflow_dispatch:
    inputs:
      prefix:
        description: 'Lettre(s) ou chiffres √† traiter'
        required: true
        default: 'x'
  schedule:
    - cron: '0 9 * * *'   # chiffres (0-9)
    - cron: '0 11 * * *'  # a b c d
    - cron: '0 13 * * *'  # e f g h
    - cron: '0 15 * * *'  # i j k l
    - cron: '0 17 * * *'  # m n o p
    - cron: '0 19 * * *'  # q r s t
    - cron: '0 21 * * *'  # u v w x
    - cron: '0 23 * * *'  # y z

jobs:
  dns-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.x

      - name: Upgrade pip
        run: python -m pip install --upgrade pip

      - name: Install dependencies
        run: pip install dnspython httpx

      - name: Determine prefix for scheduled runs
        if: github.event_name == 'schedule'
        run: |
          case "$(date +'%H')" in
            9) echo "prefix=0123456789" >> $GITHUB_ENV ;;
            11) echo "prefix=abcd" >> $GITHUB_ENV ;;
            13) echo "prefix=efgh" >> $GITHUB_ENV ;;
            15) echo "prefix=ijkl" >> $GITHUB_ENV ;;
            17) echo "prefix=mnop" >> $GITHUB_ENV ;;
            19) echo "prefix=qrst" >> $GITHUB_ENV ;;
            21) echo "prefix=uvwx" >> $GITHUB_ENV ;;
            23) echo "prefix=yz" >> $GITHUB_ENV ;;
            *) echo "prefix=x" >> $GITHUB_ENV ;;
          esac

      - name: Determine effective prefix
        id: determine-prefix
        run: |
          echo "prefix=${{ github.event.inputs.prefix || env.prefix }}" >> $GITHUB_ENV

      - name: Validate prefix
        run: |
          if [[ ! "$prefix" =~ ^[a-z0-9]+$ ]]; then
            echo "‚ùå Pr√©fixe invalide : seuls les caract√®res a-z et 0-9 sont autoris√©s."
            exit 1
          fi
          echo "‚úÖ Pr√©fixe utilis√© : $prefix"
        env:
          prefix: ${{ env.prefix }}

      - name: Run DNS checker
        run: python dns_checker.py "$prefix"
        env:
          prefix: ${{ env.prefix }}

      - name: Commit dead.txt if changed
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add dead.txt
          git diff --cached --quiet && echo "üü¢ Aucun changement √† committer." || git commit -m "üîÑ Update dead.txt for prefix '$prefix'"
          git push |

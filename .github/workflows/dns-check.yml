name: DNS Dead Check

on:
  schedule:
    - cron: '0 2 * * *'    # chiffres (0-9)
    - cron: '0 3 * * *'    # a
    - cron: '30 4 * * *'   # b
    - cron: '20 5 * * *'   # c
    - cron: '10 6 * * *'   # d
    - cron: '0 7 * * *'    # e
    - cron: '0 8 * * *'    # f
    - cron: '0 9 * * *'    # g
    - cron: '0 10 * * *'   # h
    - cron: '0 11 * * *'   # i j
    - cron: '0 12 * * *'   # k
    - cron: '0 13 * * *'   # l
    - cron: '0 14 * * *'   # m
    - cron: '0 15 * * *'   # n
    - cron: '0 16 * * *'   # o
    - cron: '0 17 * * *'   # p
    - cron: '0 18 * * *'   # q r
    - cron: '0 19 * * *'   # s
    - cron: '0 20 * * *'   # t
    - cron: '0 21 * * *'   # u v
    - cron: '0 22 * * *'   # w x y z
  workflow_dispatch:

jobs:
  dns-check:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        prefix:
          - 0 - 1 - 2 - 3 - 4 - 5 - 6 - 7 - 8 - 9
          - a
          - b
          - c
          - d
          - e
          - f
          - g
          - h
          - i
          - j
          - k
          - l
          - m
          - n
          - o
          - p
          - q
          - r
          - s
          - t
          - u
          - v
          - w
          - x
          - y
          - z

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up DNS script
        run: chmod +x dns-check.sh

      - name: Run DNS check
        env:
          SCHEDULE: ${{ github.event.schedule }}
          PREFIX: ${{ matrix.prefix }}
        run: |
          run_prefix=false

          case "$SCHEDULE" in
            "0 2 * * *")
              [[ "$PREFIX" =~ ^[0-9]$ ]] && run_prefix=true
              ;;
            "0 3 * * *")
              [[ "$PREFIX" == "a" ]] && run_prefix=true
              ;;
            "30 4 * * *")
              [[ "$PREFIX" == "b" ]] && run_prefix=true
              ;;
            "20 5 * * *")
              [[ "$PREFIX" == "c" ]] && run_prefix=true
              ;;
            "10 6 * * *")
              [[ "$PREFIX" == "d" ]] && run_prefix=true
              ;;
            "0 7 * * *")
              [[ "$PREFIX" == "e" ]] && run_prefix=true
              ;;
            "0 8 * * *")
              [[ "$PREFIX" == "f" ]] && run_prefix=true
              ;;
            "0 9 * * *")
              [[ "$PREFIX" == "g" ]] && run_prefix=true
              ;;
            "0 10 * * *")
              [[ "$PREFIX" == "h" ]] && run_prefix=true
              ;;
            "0 11 * * *")
              [[ "$PREFIX" == "i" || "$PREFIX" == "j" ]] && run_prefix=true
              ;;
            "0 12 * * *")
              [[ "$PREFIX" == "k" ]] && run_prefix=true
              ;;
            "0 13 * * *")
              [[ "$PREFIX" == "l" ]] && run_prefix=true
              ;;
            "0 14 * * *")
              [[ "$PREFIX" == "m" ]] && run_prefix=true
              ;;
            "0 15 * * *")
              [[ "$PREFIX" == "n" ]] && run_prefix=true
              ;;
            "0 16 * * *")
              [[ "$PREFIX" == "o" ]] && run_prefix=true
              ;;
            "0 17 * * *")
              [[ "$PREFIX" == "p" ]] && run_prefix=true
              ;;
            "0 18 * * *")
              [[ "$PREFIX" == "q" || "$PREFIX" == "r" ]] && run_prefix=true
              ;;
            "0 19 * * *")
              [[ "$PREFIX" == "s" ]] && run_prefix=true
              ;;
            "0 20 * * *")
              [[ "$PREFIX" == "t" ]] && run_prefix=true
              ;;
            "0 21 * * *")
              [[ "$PREFIX" == "u" || "$PREFIX" == "v" ]] && run_prefix=true
              ;;
            "0 22 * * *")
              [[ "$PREFIX" == "w" || "$PREFIX" == "x" || "$PREFIX" == "y" || "$PREFIX" == "z" ]] && run_prefix=true
              ;;
            "")
              [[ "$PREFIX" == "z" ]] && run_prefix=true
              ;;
          esac

          if [ "$run_prefix" = true ]; then
            echo "Running DNS check for prefix: $PREFIX"
            ./dns-check.sh "$PREFIX"
          else
            echo "Skipping prefix $PREFIX for this schedule."
          fi

      - name: Commit updated dead.txt
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add dead.txt
          git commit -m "Update dead.txt for prefix '${{ matrix.prefix }}'" || echo "No changes to commit"
          git push

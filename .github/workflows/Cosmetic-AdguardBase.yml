name: Filter AdGuard Rules

on:
  schedule:
    - cron: '0 3 * * *'  # Tous les jours à 3h du matin (UTC)
  workflow_dispatch:      # Déclenchement manuel possible

jobs:
  filter-rules:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download AdGuard filter file
        run: |
          curl -sSL https://raw.githubusercontent.com/AdguardTeam/FiltersRegistry/master/filters/filter_2_Base/filter.txt -o original_filter.txt

      - name: Filter rules (remove comments and simple domain rules)
        run: |
          python3 <<EOF
import re

with open("original_filter.txt", "r", encoding="utf-8") as infile:
    lines = infile.readlines()

filtered = []
for line in lines:
    line = line.rstrip('\n')
    # Supprimer les commentaires
    if line.startswith("!"):
        continue
    # Supprimer les filtres simples: ||domaine.com^
    if re.match(r"^\|\|[^$]*\^$", line):
        continue
    # Garder tout le reste (y compris les lignes vides)
    filtered.append(line)

with open("Cosmetic-AdGuardBase.txt", "w", encoding="utf-8") as outfile:
    outfile.write('\n'.join(filtered) + '\n')
EOF

      - name: Commit and push changes
        run: |
          git config user.name "GitHub Action"
          git config user.email "action@github.com"
          if git diff --exit-code Cosmetic-AdGuardBase.txt; then
            echo "No changes to commit."
          else
            git add Cosmetic-AdGuardBase.txt
            git commit -m "Update Cosmetic-AdGuardBase.txt ($(date +'%Y-%m-%d'))"
            git push
          fi
